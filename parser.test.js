const assert = require('assert');
const parser = require('./parser');

describe.skip(__filename, function() {
  describe('Negative cases', function() {
    it('should throw error for empty or invalid csv array', function() {
      assert.throws(() => {
        parser(undefined);
      }, Error, 'Data must be an array of file values');

      assert.throws(() => {
        parser([]);
      }, Error, 'Data must be an array of file values');

      assert.throws(() => {
        parser(123);
      }, Error, 'Data must be an array of file values');
    });
  });

  describe('Positive cases', function() {
    it('should return valid data', function() {
      const csvData = [[
        ['Продажи по аптекам за Январь 2022'],
        [],
        ['',
          '',
          '',
          '',
          '',
          '',
          '',
          'Код ТТ',
          'А00001',
          'А00002',
          'А00003',
          'А00004',
          'А00010',
          'А00011',
          'А00014',
          'А00022',
          'А00027',
          'А00031'],
        ['',
          '',
          '',
          '',
          '',
          '',
          '',
          'Юр.лицо ТТ',
          'ЭРКАФАРМ',
          'ЭРКАФАРМ',
          'ЭРКАФАРМ',
          'ЭРКАФАРМ',
          'ЭРКАФАРМ',
          'ЭРКАФАРМ',
          'ЭРКАФАРМ',
          'ЭРКАФАРМ',
          'ЭРКАФАРМ',
          'Вера на Веерной'],
        ['',
          '',
          '',
          '',
          '',
          '',
          '',
          'ИНН ТТ',
          '7701047916',
          '7701047916',
          '7701047916',
          '7701047916',
          '7701047916',
          '7701047916',
          '7701047916',
          '7701047916',
          '7701047916',
          '7701047916'],
        ['',
          '',
          '',
          '',
          '',
          '',
          '',
          'Субъект РФ',
          'Москва г',
          'Москва г',
          'Москва г',
          'Москва г',
          'Москва г',
          'Москва г',
          'Москва г',
          'Москва г',
          'Москва г',
          'Москва г'],
        ['',
          '',
          '',
          '',
          '',
          '',
          '',
          'Торговая точка (аптека)',
          'Москва Маросейка 2/15',
          'Москва Комсомольский пр-т 28',
          'Москва Куусинена 6',
          'Москва Красных Зорь 21',
          'Москва Расковой 12',
          'Москва Скобелевская 4',
          'Москва Зеленоград Центральный пр-т к.435',
          'Москва Зеленодольская 32 к.1',
          'Москва Седова 13 к.1',
          'Москва Рязанский пр-т 45'],
        ['Папка',
          'Товар',
          'Код АП',
          'Код Аптека2005',
          'Ср зак цена',
          'Усл цена',
          'Сумм УП',
          'Сумма Усл цена',
          'Продажи УП',
          'Продажи УП',
          'Продажи УП',
          'Продажи УП',
          'Продажи УП',
          'Продажи УП',
          'Продажи УП',
          'Продажи УП',
          'Продажи УП',
          'Продажи УП'],
        ['ИЗВАРИНО_',
          'Голдлайн плюс капс.10мг+158,5мг №30',
          '141885',
          '113711',
          '1521,71',
          '1451,54',
          '492',
          '714157.68',
          '$    ',
          '$    ',
          '$    ',
          '$    ',
          '$    ',
          '$    ',
          '$    ',
          '$    ',
          '3',
          '1'],
        ['ИЗВАРИНО_',
          'Голдлайн плюс капс.10мг+158,5мг №60',
          '142299',
          '114134',
          '2462,35',
          '2346,70',
          '92',
          '215896.4',
          '3',
          '$    ',
          '$    ',
          '$    ',
          '$    ',
          '$    ',
          '$    ',
          '$    ',
          '$    ',
          '$    ']
      ]];

      const result = parser(csvData);

      assert.strictEqual(result.type, 'parser-type');
      assert.strictEqual(result.data.length, 1);

      assert.deepStrictEqual(
        result.data[0],
        {
          client: 'ЭРКАФАРМ',
          clientType: 'pharmacy',
          code: 'Москва Маросейка 2/15',
          date: '2022-01-01T00:00:00.000Z',
          quantity: 3,
          inn: '7701047916',
          region: 'Москва г',
          selfReseller: 'ООО "ЭРКАФАРМ Северо-Запад"',
          title: 'Голдлайн плюс капс.10мг+158,5мг №60',
          tranType: 'purchase',
        },
      );
    });

    it('should return valid data (with removing totals)', function() {
      const csvData = [[
        ['Продажи по аптекам за Январь 2022'],
        [],
        ['',
          '',
          '',
          '',
          '',
          '',
          '',
          'Код ТТ',
          'А00001',
          'А00002',
          'А00003',
          'А00004',
          'А00010',
          'А00011',
          'А00014',
          'А00022',
          'А00027',
          'А00031'],
        ['',
          '',
          '',
          '',
          '',
          '',
          '',
          'Юр.лицо ТТ',
          'ЭРКАФАРМ',
          'ЭРКАФАРМ',
          'ЭРКАФАРМ',
          'ЭРКАФАРМ',
          'ЭРКАФАРМ',
          'ЭРКАФАРМ',
          'ЭРКАФАРМ',
          'ЭРКАФАРМ',
          'ЭРКАФАРМ',
          'Вера на Веерной'],
        ['',
          '',
          '',
          '',
          '',
          '',
          '',
          'ИНН ТТ',
          '7701047916',
          '7701047916',
          '7701047916',
          '7701047916',
          '7701047916',
          '7701047916',
          '7701047916',
          '7701047916',
          '7701047916',
          '7701047916'],
        ['',
          '',
          '',
          '',
          '',
          '',
          '',
          'Субъект РФ',
          'Москва г',
          'Москва г',
          'Москва г',
          'Москва г',
          'Москва г',
          'Москва г',
          'Москва г',
          'Москва г',
          'Москва г',
          'Москва г'],
        ['',
          '',
          '',
          '',
          '',
          '',
          '',
          'Торговая точка (аптека)',
          'Москва Маросейка 2/15',
          'Москва Комсомольский пр-т 28',
          'Москва Куусинена 6',
          'Москва Красных Зорь 21',
          'Москва Расковой 12',
          'Москва Скобелевская 4',
          'Москва Зеленоград Центральный пр-т к.435',
          'Москва Зеленодольская 32 к.1',
          'Москва Седова 13 к.1',
          'Москва Рязанский пр-т 45'],
        ['Папка',
          'Товар',
          'Код АП',
          'Код Аптека2005',
          'Ср зак цена',
          'Усл цена',
          'Сумм УП',
          'Сумма Усл цена',
          'Продажи УП',
          'Продажи УП',
          'Продажи УП',
          'Продажи УП',
          'Продажи УП',
          'Продажи УП',
          'Продажи УП',
          'Продажи УП',
          'Продажи УП',
          'Продажи УП'],
        ['ИЗВАРИНО_',
          'Голдлайн плюс капс.10мг+158,5мг №30',
          '141885',
          '113711',
          '1521,71',
          '1451,54',
          '492',
          '714157.68',
          '$    ',
          '$    ',
          '$    ',
          '$    ',
          '$    ',
          '$    ',
          '$    ',
          '$    ',
          '3',
          '1'],
        ['ИЗВАРИНО_',
          'Голдлайн плюс капс.10мг+158,5мг №60',
          '142299',
          '114134',
          '2462,35',
          '2346,70',
          '92',
          '215896.4',
          '3',
          '$    ',
          '$    ',
          '$    ',
          '$    ',
          '$    ',
          '$    ',
          '$    ',
          '$    ',
          '$    '],
        ['ИЗВАРИНО_ Итог',
          '',
          '',
          '',
          '',
          '',
          '21138',
          '9316732.4999999',
          '21',
          '5',
          '9',
          '16',
          '11',
          '14',
          '8',
          '16',
          '4',
          '10']
      ]];

      const result = parser(csvData);

      assert.strictEqual(result.type, 'parser-type');
      assert.strictEqual(result.data.length, 1);

      assert.deepStrictEqual(
        result.data[0],
        {
          client: 'ЭРКАФАРМ',
          clientType: 'pharmacy',
          code: 'Москва Маросейка 2/15',
          date: '2022-01-01T00:00:00.000Z',
          quantity: 3,
          inn: '7701047916',
          region: 'Москва г',
          selfReseller: 'ООО "ЭРКАФАРМ Северо-Запад"',
          title: 'Голдлайн плюс капс.10мг+158,5мг №60',
          tranType: 'purchase',
        },
      );
    });
  });
});
